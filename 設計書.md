# 展開済みMinecraft Modフォルダ整理GUIツール 設計書 v1.0

## 1. 目的
7zip等で展開済みのMinecraft Modフォルダ群を対象に、各Mod内の `assets/<modid>/lang/` の言語ファイルだけを抽出して Mod直下へ集約し、それ以外のファイル/フォルダを削除する。
PowerShellで実現している処理を、誤操作しにくいGUIとして提供する。

## 2. 対象環境
- OS: Windows 10/11
- ランタイム: .NET 8 Desktop Runtime（同梱/自己完結配布を選択可能）
- GUI: WPF（MVVM）
- 入力: 展開済みModフォルダ群（ディレクトリ）
  - 追加要件（v1.1）: オプションで親フォルダ直下の `.jar` も対象に含められる

## 3. 用語
- 「親フォルダ」: Modフォルダ群が直下に並ぶディレクトリ
- 「Modフォルダ」: 親フォルダ直下にある各ディレクトリ（例: `cloth-config-11.1.136-forge`）
- 「langソース」: `assets/<modid>/lang` に一致するディレクトリ
- 「lang出力先」: `Modフォルダ直下/lang`

## 4. 要求仕様（機能要件）

### 4.1 フォルダ選択
- 親フォルダをユーザーが選択できる（フォルダピッカー）
- 親フォルダ直下の「ディレクトリのみ」をModフォルダとして列挙

### 4.2 解析（スキャン）
各Modフォルダに対し以下を判定し、結果一覧に表示する。
- `assets` の有無
- `assets/<modid>/lang` の検出有無（複数検出の可能性あり）
- 処理方針（後述）と削除/移動対象件数の概算

### 4.3 実行（PowerShell相当の処理）
対象: 親フォルダ直下の各Modフォルダ

#### J) jarモード（.jarのままlang抽出）
- 親フォルダ直下の `.jar` を対象に含められる（オプション）
- `.jar` は改変しない（削除/再パックしない）
- `.jar` 内の `assets/<modid>/lang/` 配下の言語ファイル（`.json` / `.lang`）のみを抽出する
- 抽出先は `.jar` と同じフォルダ直下（例: `<親フォルダ>/<jar名>/lang/`）とする

#### A) langが見つかった場合
1. `Mod直下/lang` を用意（存在しなければ作成）
2. `langソース` 配下の直下要素（ファイル/フォルダ）を `Mod直下/lang` に移動
   - 同名が存在する場合は「上書き」（既存を削除してから移動）とする
3. `Mod直下` のうち `lang` 以外を全削除（ファイル/フォルダを再帰削除）
4. 最終的に「Mod直下に `lang` のみが残る」状態にする

#### B) langが見つからない場合
- Modフォルダ自体は残し、Modフォルダ直下の中身（子要素）を全削除して空にする
- その旨を通知/ログ出力する

#### C) 複数lang候補が見つかった場合
- デフォルトは「最初に見つかった1件を採用」
- UIで「最初の1件」or「全候補を統合」を選択可能にする（オプション）

### 4.4 ドライラン（プレビュー）
- 実際には変更しない「プレビュー実行」モードを用意
- 実行時に行われる予定の操作（移動/削除）を一覧表示できる

### 4.5 ログ/通知
- 画面内ログ（時刻/レベル/メッセージ）
- 実行結果サマリ（成功数、langあり、langなし、失敗数）
- 任意でログのファイル出力（例: `run-log.txt`）

### 4.6 安全対策（誤削除防止）
- 実行前に確認ダイアログを必須
- 「langなしの場合に中身全削除」も明示警告
- オプションで「ゴミ箱へ移動」（可能なら）/「完全削除」を選択
  - 既定: 完全削除（PowerShell互換）
- オプションで「バックアップ作成（Zip）」を実行前に取れる
  - 既定: OFF（Git管理で不要な場合があるため）

## 5. 非機能要件
- UIが固まらない（バックグラウンドスレッドで処理、進捗表示）
- 大量Modでも耐える（逐次処理＋キャンセル対応）
- パスが日本語でも動作（Unicode前提）
- 失敗しても可能な限り継続（Mod単位で例外を握り、次へ）

## 6. UI設計

### 6.1 画面構成（単一ウィンドウ）
1) 上部: 親フォルダ選択
- [参照...] ボタン
- 選択パス表示（コピー可能）

2) オプション領域
- チェック: □ ドライラン（変更しない）
- チェック: □ jarも対象（jarのままlang抽出）
- 選択: lang複数時の扱い
  - ○ 最初の1件を採用（既定）
  - ○ 全候補を統合（同名は上書き）
- 選択: 削除方式
  - ○ 完全削除（既定）
  - ○ ゴミ箱へ（実装可能なら）
- チェック: □ 実行前バックアップ（Zip）

3) スキャン結果テーブル
- 列例:
  - Mod名
  - assets有無
  - lang検出（0/1/複数）
  - 処理方針（A/B）
  - 予定操作件数（削除/移動）
  - ステータス（未処理/成功/警告/失敗）

4) 実行コントロール
- [スキャン] [実行] [キャンセル]
- 進捗バー（全体％ + 現在のMod名）

5) ログビュー
- スクロール可能
- [ログ保存] ボタン

### 6.2 UXルール
- フォルダ選択後は自動で軽いスキャンを提案（自動実行はしない）
- 実行ボタンは「スキャン完了」まで非活性
- キャンセルは「次のModに移る」タイミングで反映（安全優先）

## 7. 処理仕様（アルゴリズム）

### 7.1 Mod列挙
- `TargetDir` 直下のディレクトリ一覧を取得
- ファイルは無視

### 7.2 lang探索
- `Mod/assets` が無ければ lang無し扱い
- `Mod/assets` 配下を再帰検索し、パス末尾が `assets/<something>/lang` に一致するディレクトリを候補とする
  - 正規表現相当: `.../assets/[^/]+/lang`
- 候補0 → B処理
- 候補1 → A処理（その候補）
- 候補複数 → UIオプションに従う

### 7.3 A処理（langあり）
- `DstLang = Mod/lang` 作成（存在してもOK）
- `SrcLang` 直下の全要素を列挙し、各要素について:
  - `DestPath = DstLang/<name>`
  - `DestPath` が存在する場合は削除してから移動（上書き）
  - 移動
- その後 `Mod` 直下の `lang` 以外をすべて削除

### 7.4 B処理（langなし）
- `Mod` 直下の全子要素を削除（Modフォルダは残す）

### 7.5 ドライラン
- 実際の `Move/Delete` を行わず、
  - 予定される操作（Move/Delete）をOperation一覧として構築し画面に出す
- 実行ログには「DRY-RUN」を明記

## 8. エラー処理
- Mod単位で try/catch
- よくある失敗:
  - アクセス拒否（読み取り専用/権限）
  - ファイルロック（別プロセスが掴んでいる）
  - パス長制限（古い環境）
- 失敗時は:
  - ステータスを「失敗」にし、例外メッセージをログ出力
  - 可能なら次のModへ継続

## 9. 実装方針（アーキテクチャ）
- パターン: MVVM
- 主な層:
  - UI層（WPF XAML）
  - ViewModel層（状態管理、コマンド）
  - Domain層（ModScan/Plan/Execute）
  - Infrastructure層（ファイル操作、ログ、ゴミ箱、Zip）

### 9.1 主要クラス案
- `MainViewModel`
  - `TargetDir`
  - `Options`（DryRun, MultiLangMode, DeleteMode, BackupZip）
  - `ObservableCollection<ModItemViewModel> Mods`
  - Commands: `BrowseCommand`, `ScanCommand`, `ExecuteCommand`, `CancelCommand`, `SaveLogCommand`

- `ModScanner`
  - `Scan(targetDir) -> List<ModScanResult>`

- `OperationPlanner`
  - `BuildPlan(modScanResult, options) -> ExecutionPlan`
  - Planは「操作列（Move/Delete/CreateDir）」を持つ

- `Executor`
  - `Execute(plan, options, IProgress, CancellationToken)`

- `FileSystem`
  - `EnsureDir(path)`
  - `MoveWithOverwrite(src, dst)`
  - `DeleteRecursive(path, deleteMode)`

- `Logger`
  - `Info/Warn/Error`
  - `Export(path)`

## 10. Git運用上の注意（重要）
- 「langが無いModは中身を消して空フォルダを残す」場合、
  - Gitは空フォルダを追跡しないため、空のままだとリポジトリ上からは消える可能性がある
- 空フォルダも残したい場合のみ、オプションで `.gitkeep` を生成する設計も可能
  - ただし「無駄なファイル増やしたくない」方針に反するため既定はOFF

## 11. テスト観点
- 正常系:
  - langあり（jsonのみ / 複数ファイル / サブフォルダあり）
  - `Mod直下に既にlangがある`（上書き統合）
  - 複数lang候補（最初採用/統合）
- 異常系:
  - assets無し
  - lang無し → 中身全削除（フォルダ維持）
  - 読み取り専用/権限不足/ロック
- ドライラン:
  - 予定操作が実行結果と一致する（件数/対象）

## 12. 配布
- 方式A: Single-file self-contained（.NET同梱、導入が簡単、容量増）
- 方式B: framework-dependent（軽いがRuntime要）

## 13. 今後の拡張
- 「対象を親フォルダ直下だけでなく再帰的に探す」
- 「削除前に差分一覧をエクスポート（CSV/JSON）」
- 「Git status を表示して影響範囲を把握」
- 「除外ルール（例: `README.md` は残す等）」
